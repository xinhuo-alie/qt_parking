# 停车场管理系统 - 总体架构设计

## 1. 系统概述

停车场管理系统是一个基于Qt框架开发的客户端应用程序，用于管理停车场的车位、车辆信息和统计报告。系统采用模块化设计，具有良好的扩展性和可维护性。

## 2. 总体架构设计

### 2.1 架构分层

系统采用经典的三层架构设计，包括表现层、业务逻辑层和数据访问层：

```
┌─────────────────────────────────────────────────────────┐
│                     表现层 (UI Layer)                   │
│  ┌─────────────┐  ┌──────────────────┐  ┌─────────────┐ │
│  │  MainMenu   │  │ ReportStatistics │  │ ParkingSpace │ │
│  │ (主菜单)    │  │ (报告统计)       │  │ Visualizer   │ │
│  └─────────────┘  └──────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────┐
│                    业务逻辑层 (BLL Layer)               │
│  ┌─────────────────────┐  ┌─────────────────────────┐   │
│  │ ParkingSpaceManager │  │     业务规则引擎        │   │
│  │ (停车位管理)        │  │ (处理业务逻辑和规则)    │   │
│  └─────────────────────┘  └─────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────┐
│                    数据访问层 (DAL Layer)               │
│  ┌─────────────────┐  ┌───────────────────┐  ┌────────┐ │
│  │ NetworkManager  │  │    数据转换层     │  │ API   │ │
│  │ (网络通信)      │  │ (JSON/对象转换)   │  │ 配置  │ │
│  └─────────────────┘  └───────────────────┘  └────────┘ │
└─────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────┐
│                     外部系统 (External)                 │
│  ┌─────────────────────────────────────────────────┐   │
│  │                停车场管理系统服务器             │   │
│  │ (提供RESTful API服务)                          │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 2.2 模块划分

| 模块名称 | 主要职责 | 文件位置 | 依赖关系 |
|---------|---------|---------|---------|
| **主菜单模块** | 提供系统入口和主要功能导航 | MainMenu.cpp/.h/.ui | Qt Widgets |
| **报告统计模块** | 展示各类统计报告和数据分析 | ReportStatistics.cpp/.h/.ui | NetworkManager, ParkingSpaceManager |
| **停车位可视化模块** | 图形化展示停车位状态和布局 | ParkingSpaceVisualizer.cpp/.h | Qt Widgets |
| **停车位管理模块** | 处理停车位的增删改查业务逻辑 | ParkingSpaceManager.cpp/.h | NetworkManager |
| **网络管理模块** | 处理与服务器的HTTP通信 | NetworkManager.cpp/.h | Qt Network |
| **API配置模块** | 管理API地址和配置信息 | apiconfig.cpp/.h | - |
| **应用入口模块** | 程序启动和初始化 | main.cpp | - |

## 3. 核心模块详细设计

### 3.1 表现层设计

#### 3.1.1 主菜单 (MainMenu)

- **功能**：系统的入口界面，提供主要功能按钮导航
- **界面组件**：
  - 系统标题（中上方）
  - 功能按钮（停车场管理、报告统计等）
  - 样式设计：渐变按钮、颜色编码、悬停效果
- **交互流程**：
  1. 点击功能按钮
  2. 创建并显示对应子窗口
  3. 隐藏主菜单

#### 3.1.2 报告统计 (ReportStatistics)

- **功能**：展示各类统计报告和数据分析
- **界面组件**：
  - 报告类型按钮组
  - 报告显示区域（表格、图表）
  - 操作按钮（刷新、导出等）
  - 样式设计：绿色主基调、分组框、数据表格美化
- **交互流程**：
  1. 选择报告类型
  2. 发送请求获取数据
  3. 解析并展示报告数据
  4. 提供导出或打印功能

#### 3.1.3 停车位可视化 (ParkingSpaceVisualizer)

- **功能**：图形化展示停车位状态和布局
- **界面组件**：
  - 停车位绘制区域
  - 状态颜色编码（已占用、空闲、VIP等）
  - 详细信息弹窗
- **交互流程**：
  1. 加载停车位数据
  2. 计算并绘制停车位
  3. 响应鼠标点击事件
  4. 显示停车位详细信息

### 3.2 业务逻辑层设计

#### 3.2.1 停车位管理 (ParkingSpaceManager)

- **功能**：处理停车位相关的业务逻辑
- **核心方法**：
  - 停车位CRUD操作（添加、查询、更新、删除）
  - 报告生成和统计分析
  - 停车位状态管理
- **设计模式**：
  - 单例模式（全局唯一实例）
  - 策略模式（不同报告类型的生成策略）

### 3.3 数据访问层设计

#### 3.3.1 网络管理 (NetworkManager)

- **功能**：处理与服务器的HTTP通信
- **核心方法**：
  - GET请求（获取数据）
  - POST请求（提交数据）
  - PUT请求（更新数据）
  - DELETE请求（删除数据）
- **技术实现**：
  - 使用Qt Network模块
  - 异步请求处理
  - 错误处理和重试机制

#### 3.3.2 API配置 (ApiConfig)

- **功能**：管理API地址和配置信息
- **核心属性**：
  - 服务器地址
  - API版本
  - 超时设置
  - 认证信息

## 4. 数据流设计

### 4.1 数据流动过程

1. **用户操作**：用户在UI层进行操作（如点击按钮）
2. **UI事件处理**：UI组件处理用户事件，调用业务逻辑层
3. **业务逻辑处理**：业务逻辑层处理请求，调用数据访问层
4. **网络请求**：数据访问层发送HTTP请求到服务器
5. **服务器响应**：服务器处理请求并返回响应
6. **数据解析**：数据访问层解析响应数据
7. **结果处理**：业务逻辑层处理解析后的数据
8. **UI更新**：UI层更新界面显示结果

### 4.2 数据格式

系统使用JSON格式进行数据交换：

```json
// 停车位数据示例
{
  "id": 1,
  "location": "A区-101",
  "type": "VIP",
  "status": "occupied",
  "hourly_rate": 5.0,
  "vehicle_info": {
    "license_plate": "京A12345",
    "entry_time": "2023-01-01T10:00:00Z"
  }
}

// 报告数据示例
{
  "report_type": "revenue",
  "period": "2023-01",
  "data": {
    "total_revenue": 15000,
    "daily_average": 500,
    "peak_days": ["2023-01-15", "2023-01-20"]
  }
}
```

## 5. 技术架构

### 5.1 开发框架

- **前端框架**：Qt 5.x/6.x
- **UI组件**：Qt Widgets
- **样式技术**：Qt Style Sheets (QSS)
- **网络通信**：Qt Network

### 5.2 设计模式

- **单例模式**：NetworkManager, ParkingSpaceManager
- **MVC模式**：UI与业务逻辑分离
- **观察者模式**：事件处理和信号槽机制
- **策略模式**：不同报告类型的生成策略

### 5.2.1 登录注册模块
  例：getweather函数发送send请求到mNetmessage，通过调用onReplied，返回finished信号。在左上角输入要查询的城市，点击查询按钮，若输入正确就会发送http请求给服务器，请求回来的天气数据为Josn格式，通过解析Josn获得一周天气信息，最高温曲线，最低温曲线。
  
  此处为流程图：

### 5.2.2 停车场车位状态实时展示模块
  getParkingSpaces函数发送GET请求到NetworkManager，通过调用回调函数处理服务器响应。在停车位可视化窗口中，系统自动加载或用户点击刷新按钮后，会发送HTTP请求到服务器获取停车位数据。请求回来的数据为JSON格式，通过解析JSON获得停车位列表，包括每个车位的ID、位置、类型、状态等信息。系统根据这些信息绘制停车位的可视化视图，使用不同颜色区分车位状态（已占用：番茄红，空闲普通：浅绿，空闲VIP：浅蓝），并在车位上显示编号、VIP标识和状态标签。用户可以点击停车位查看详细信息。
  
  此处为流程图：
  1. 用户进入停车位可视化窗口或点击刷新按钮
  2. ParkingSpaceManager调用getParkingSpaces方法
  3. NetworkManager发送GET请求到服务器的/spaces接口
  4. 服务器返回包含停车位数据的JSON响应
  5. NetworkManager解析响应并调用成功回调函数
  6. ParkingSpaceManager将停车位数据传递给ParkingSpaceVisualizer
  7. ParkingSpaceVisualizer调用setParkingSpaces方法设置数据
  8. calculateSpacePositions计算每个停车位的位置
  9. paintEvent绘制所有停车位（根据状态和类型使用不同颜色）
  10. 用户点击停车位时，mousePressEvent检测点击位置并显示详细信息

### 5.3 关键技术点

- **样式设计**：
  - 渐变色按钮 (`qlineargradient`)
  - 颜色编码（功能组主题色）
  - 过渡动画和悬停效果
  - 阴影和边框圆角

- **网络通信**：
  - RESTful API调用
  - 异步请求处理
  - 错误处理和重试机制

- **数据可视化**：
  - 自定义绘制 (`QPainter`)
  - 状态颜色区分
  - 交互反馈

## 6. 系统扩展设计

### 6.1 模块扩展点

- **新功能模块**：通过添加新的UI类和业务逻辑类实现
- **报告类型**：在ParkingSpaceManager中添加新的报告生成方法
- **数据可视化**：扩展ParkingSpaceVisualizer的绘制逻辑

### 6.2 技术扩展点

- **数据库支持**：添加本地数据库支持（SQLite）
- **图表库集成**：集成第三方图表库（如Qt Charts）
- **云服务集成**：添加云存储和远程监控功能
- **移动客户端**：开发移动端应用（Qt for Android/iOS）

### 6.2.1 停车场管理系统模块主要算法设计
停车场管理系统模块的算法设计主要分为三个部分：数据获取、数据处理和可视化展示。

1. **数据获取**：
停车场管理系统需要从服务器获取实时的停车位数据，主要通过RESTful API接口实现。
- **停车位信息获取**：
  使用GET请求访问服务器的/spaces接口，可通过参数筛选特定状态（如已占用、空闲）或类型（如普通、VIP）的停车位。接口返回包含停车位详细信息的JSON数据，包括车位ID、位置、类型、状态、小时费率等。
- **报告数据获取**：
  使用GET请求访问服务器的/reports接口系列，可获取收入报告、停车统计报告、空间使用率报告等。接口支持通过日期范围、报告类型等参数进行筛选，返回包含统计数据的JSON响应。

2. **数据处理**：
获取到数据后，需要对其进行处理，提取出需要的信息，并进行业务逻辑处理。
- **数据解析**：
  对于服务器返回的JSON格式数据，使用Qt自带的QJsonDocument和QJsonObject模块进行解析，提取出停车位的各项属性和报告数据。例如，从JSON数组中遍历每个停车位对象，获取其ID、位置、类型、状态等信息。
- **业务逻辑处理**：
  - **停车位状态管理**：根据服务器返回的状态信息，更新本地停车位数据。当车位状态发生变化时（如从空闲变为已占用），触发相应的可视化更新。
  - **报告数据计算**：对原始报告数据进行进一步计算，如计算平均占用率、高峰时段、收入趋势等。例如，从收入报告中提取每日收入数据，计算月平均收入和峰值收入。
  - **计费逻辑**：根据停车位的小时费率和停车时长，计算停车费用。例如，使用entry_time和当前时间计算停车时长，再乘以hourly_rate得到总费用。

3. **可视化展示**：
将处理后的数据展示到用户界面上，提供直观的停车位状态视图和报告统计图表。
- **停车位可视化**：
  - **位置计算**：根据窗口大小和停车位数量，计算每个停车位的位置坐标。使用网格布局算法，确保停车位排列整齐且美观。
  - **颜色编码**：根据停车位状态和类型使用不同颜色绘制：已占用车位使用番茄红，空闲普通车位使用浅绿，空闲VIP车位使用浅蓝。
  - **信息标注**：在停车位上标注车位编号、VIP标识和状态标签。使用不同字体和样式区分不同类型的信息。
- **报告数据展示**：
  - **表格展示**：将报告数据以表格形式展示，如收入报表、车辆统计等。使用QTableWidget组件，设置合适的列宽和样式。
  - **图表展示**：对于趋势数据和分布数据，使用图表进行可视化，如收入趋势图、车辆类型分布图等。可集成Qt Charts库实现柱状图、折线图、饼图等图表类型。
  - **摘要信息**：在仪表板中展示关键指标的摘要信息，如总车位数、当前占用数、今日收入等，使用大号字体和醒目的颜色突出显示。

## 7. 性能与安全设计

### 7.1 性能优化

- **异步请求**：网络请求异步处理，避免UI阻塞
- **数据缓存**：缓存频繁访问的数据
- **延迟加载**：按需加载数据和UI组件
- **绘制优化**：优化自定义绘制逻辑，减少重绘

### 7.2 安全设计

- **API认证**：使用API密钥或令牌认证
- **数据加密**：敏感数据加密传输
- **输入验证**：客户端输入验证
- **错误处理**：安全的错误信息展示，避免泄露敏感信息

## 8. 部署与维护

### 8.1 部署方式

- **Windows**：打包为可执行文件 (.exe)
- **Linux**：打包为AppImage或deb/rpm包
- **macOS**：打包为.app应用

### 8.2 维护支持

- **日志记录**：系统操作和错误日志
- **版本更新**：支持在线更新
- **故障诊断**：提供诊断工具和日志分析

## 9. 总结

停车场管理系统采用分层架构设计，具有良好的模块化和可扩展性。系统通过表现层提供直观的用户界面，业务逻辑层处理核心业务规则，数据访问层负责与服务器通信。各层之间通过清晰的接口交互，确保系统的可维护性和可扩展性。

系统的关键设计点包括：
- 模块化的架构设计
- 丰富的UI样式和交互效果
- 灵活的报告生成和统计分析
- 直观的停车位可视化
- 安全可靠的网络通信

该架构设计为系统的后续扩展和维护提供了坚实的基础。